(self.webpackChunkrabonjs_docs=self.webpackChunkrabonjs_docs||[]).push([[849],{81330:(e,t,a)=>{"use strict";a.r(t),a.d(t,{HomeAwaySelector:()=>g,MatchSelector:()=>d,PassNetwork:()=>f,PassNetwork2:()=>b,Pitch:()=>h,assets:()=>m,contentTitle:()=>p,default:()=>_,frontMatter:()=>l,getPassNetworkData:()=>w,metadata:()=>c,mirrorX:()=>v,mirrorY:()=>y,norm:()=>k,toc:()=>u});var n=a(87462),s=a(67294),o=a(3905),i=a(5543),r=a(93889);const l={sidebar_position:1},p="Creating a pass network using DanfoJS",c={unversionedId:"tutorial-advanced/plot-pass-network",id:"tutorial-advanced/plot-pass-network",title:"Creating a pass network using DanfoJS",description:"In this tutorial, we will learn how to create a pass network using DanfoJS and RabonaJS.",source:"@site/docs/tutorial-advanced/plot-pass-network.mdx",sourceDirName:"tutorial-advanced",slug:"/tutorial-advanced/plot-pass-network",permalink:"/rabonajs-docs/docs/tutorial-advanced/plot-pass-network",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-advanced/plot-pass-network.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Tutorial - Advanced",permalink:"/rabonajs-docs/docs/category/tutorial---advanced"}},m={},h=()=>{const[e,t]=(0,s.useState)(null),a={height:80,width:120,padding:100,linecolour:"#ffffff",fillcolour:"#7ec850"};return(0,s.useEffect)((()=>{if(!e){const e=i.Z.pitch("pitch_start",a);t(e)}}),[]),(0,o.kt)("div",{id:"pitch_start",style:{width:"750px",margin:"auto"}})},d=e=>{let{onChange:t}=e;const[a,n]=(0,s.useState)([]);return(0,s.useEffect)((()=>{(async()=>{const e=await fetch("https://raw.githubusercontent.com/statsbomb/open-data/master/data/matches/2/44.json"),t=await e.json();n(t)})()}),[]),(0,o.kt)("div",null,(0,o.kt)("select",{onChange:e=>(e=>{t(a.find((t=>t.match_id==e)))})(e.target.value)},a.map((e=>(0,o.kt)("option",{key:e.match_id,value:e.match_id},e.home_team.home_team_name," ",e.home_score," -"," ",e.away_score," ",e.away_team.away_team_name)))))},u=[{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Getting started",id:"getting-started",level:2},{value:"Loading the data",id:"loading-the-data",level:2},{value:"MatchSelector Component",id:"matchselector-component",level:3},{value:"Try it out \u26bd\ufe0f",id:"try-it-out-\ufe0f",level:3},{value:"Creating the pass network",id:"creating-the-pass-network",level:2},{value:"Fetch the match data",id:"fetch-the-match-data",level:3},{value:"Creating the pass network",id:"creating-the-pass-network-1",level:3},{value:"Home and away selector component",id:"home-and-away-selector-component",level:3},{value:"Final Result",id:"final-result",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:2},{value:"Try it out \u26bd\ufe0f",id:"try-it-out-\ufe0f-1",level:3},{value:"Flipping away team coordinates",id:"flipping-away-team-coordinates",level:3},{value:"Try it out \u26bd\ufe0f",id:"try-it-out-\ufe0f-2",level:3}],g=e=>{let{homeAway:t,onActiveTeamChange:a,activeTeamId:n}=e;return t&&(0,o.kt)("div",null,(0,o.kt)("label",null,(0,o.kt)("input",{type:"radio",name:"home-away",value:t.home,checked:t.home==n,onChange:e=>a(e.target.value)}),"Home"),(0,o.kt)("label",null,(0,o.kt)("input",{type:"radio",name:"home-away",value:t.away,checked:t.away==n,onChange:e=>a(e.target.value)}),"Away"))},w=async e=>{const t=await fetch("https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/"+e+".json"),a=await t.json(),n=[];for(let r=0;r<a.length;r++){const e=a[r];if("Substitution"===e.type.name)break;"Pass"===a[r].type.name&&e.pass.recipient&&n.push({startX:e.location[0],startY:e.location[1],endX:e.pass.end_location[0],endY:e.pass.end_location[1],teamId:e.team.id,passer:e.player?.id,passerName:e.player?.name,recipient:e.pass.recipient?.id})}const s=new r.DataFrame(n),o=s.groupby(["passer","teamId"]).agg({startX:"mean",startY:["mean","count"]}).rename({startX_mean:"startX",startY_mean:"startY"}).rename({startY_count:"total_pass_count"}),i=s.groupby(["passer","recipient","passerName"]).agg({startY:["count"]}).rename({startY_count:"count"}).rename({passerName:"label"}),l=(0,r.merge)({left:i,right:o,on:["passer"],how:"left"});let p=(0,r.toJSON)(l),c=(0,r.toJSON)(o);return p.map((e=>({...e,endX:c.find((t=>e.recipient===t.passer)).startX,endY:c.find((t=>e.recipient===t.passer)).startY,startX:e.startX,startY:e.startY,label:e.label.split(" ")[1]})))},k=function(e,t,a){return void 0===t&&(t=2),void 0===a&&(a=0),(e-a)/(t-a)},f=()=>{const[e,t]=(0,s.useState)(null),[a,n]=(0,s.useState)(null),[r,l]=(0,s.useState)(null),[p,c]=(0,s.useState)(null),m={height:80,width:120,padding:100,linecolour:"#ffffff",fillcolour:"#7ec850"};(0,s.useEffect)((()=>{if(!e){const e=i.Z.pitch("pitch",m);t(e)}}),[]);const h=(t,a)=>{const n=t.filter((e=>e.teamId==a));e.removeAllLayers(),i.Z.layer({type:"ballMovement",data:n,options:{color:"yellow",getWidth:e=>k(e?.count)}}).addTo(e)};return(0,o.kt)(s.Fragment,null,(0,o.kt)(d,{onChange:async e=>{n({home:e.home_team.home_team_id,away:e.away_team.away_team_id}),l(e.home_team.home_team_id);const t=await w(e.match_id);c(t),h(t,e.home_team.home_team_id)},mdxType:"MatchSelector"}),(0,o.kt)(g,{homeAway:a,onActiveTeamChange:e=>{l(e),h(p,e)},activeTeamId:r,mdxType:"HomeAwaySelector"}),(0,o.kt)("div",{id:"pitch",style:{width:"750px",margin:"auto"}}))},v=(e,t)=>t?.getOptions().width-e,y=(e,t)=>t?.getOptions().height-e,b=()=>{const[e,t]=(0,s.useState)(null),[a,n]=(0,s.useState)(null),[l,p]=(0,s.useState)(null),[c,m]=(0,s.useState)(null),h={height:80,width:120,padding:100,linecolour:"#ffffff",fillcolour:"#7ec850"};(0,s.useEffect)((()=>{if(!e){const e=i.Z.pitch("pitch2",h);t(e)}}),[]);const u=(t,a)=>{const n=t.filter((e=>e.teamId==a));e.removeAllLayers(),i.Z.layer({type:"ballMovement",data:n,options:{color:"yellow",getWidth:e=>k(e?.count)}}).addTo(e)};return(0,o.kt)(s.Fragment,null,(0,o.kt)(d,{onChange:async t=>{n({home:t.home_team.home_team_id,away:t.away_team.away_team_id}),p(t.home_team.home_team_id);const a=await(async(t,a)=>{const n=await fetch("https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/"+t+".json"),s=await n.json(),o=e=>a===e,i=[];for(let r=0;r<s.length;r++){const t=s[r];if("Substitution"===t.type.name)break;"Pass"===s[r].type.name&&t.pass.recipient&&i.push({startX:o(t.team.id)?t.location[0]:v(t.location[0],e),startY:o(t.team.id)?t.location[1]:y(t.location[1],e),endX:o(t.team.id)?t.pass.end_location[0]:v(t.pass.end_location[0],e),endY:o(t.team.id)?t.pass.end_location[1]:y(t.pass.end_location[1],e),teamId:t.team.id,passer:t.player?.id,passerName:t.player?.name,recipient:t.pass.recipient?.id})}const l=new r.DataFrame(i),p=l.groupby(["passer","teamId"]).agg({startX:"mean",startY:["mean","count"]}).rename({startX_mean:"startX",startY_mean:"startY"}).rename({startY_count:"total_pass_count"}),c=l.groupby(["passer","recipient","passerName"]).agg({startY:["count"]}).rename({startY_count:"count"}).rename({passerName:"label"}),m=(0,r.merge)({left:c,right:p,on:["passer"],how:"left"});let h=(0,r.toJSON)(m),d=(0,r.toJSON)(p);return h.map((e=>({...e,endX:d.find((t=>e.recipient===t.passer)).startX,endY:d.find((t=>e.recipient===t.passer)).startY,startX:e.startX,startY:e.startY,label:e.label.split(" ")[1]})))})(t.match_id,t.home_team.home_team_id);m(a),u(a,t.home_team.home_team_id)},mdxType:"MatchSelector"}),(0,o.kt)(g,{homeAway:a,onActiveTeamChange:e=>{p(e),u(c,e)},activeTeamId:l,mdxType:"HomeAwaySelector"}),(0,o.kt)("div",{id:"pitch2",style:{width:"750px",margin:"auto"}}))},N={Pitch:h,MatchSelector:d,toc:u,HomeAwaySelector:g,getPassNetworkData:w,norm:k,PassNetwork:f,mirrorX:v,mirrorY:y,PassNetwork2:b};function _(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},N,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"creating-a-pass-network-using-danfojs"},"Creating a pass network using DanfoJS"),(0,o.kt)("p",null,"In this tutorial, we will learn how to create a pass network using DanfoJS and RabonaJS.\nWe will be using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/statsbomb/open-data"},"StatsBomb open dataset")," for this tutorial."),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"A pass network is a graph that shows the passing relationships between players in a football match.\nIt is a useful tool for analyzing the passing patterns of a team and the players involved in the passing sequences.\nIt can also be used to identify the players who are most involved in the passing sequences."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"Even though we are going to explain the code in detail,\nit could be nice to have a look at the ",(0,o.kt)("a",{parentName:"p",href:"https://danfo.jsdata.org/"},"Danfo documentation"),". It is the replacement of\npandas in JS ecosystem with a similar syntax."),(0,o.kt)("h2",{id:"getting-started"},"Getting started"),(0,o.kt)("p",null,"We will be using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/statsbomb/open-data/blob/master/data/matches/2/44.json"},"StatsBomb open dataset")," for this tutorial.\nThe dataset we are going to use contains data for all the matches played by Arsenal in the famouse 2003-2004 season.\nThe invincible season in which Arsenal won the Premier League without losing a single match."),(0,o.kt)("p",null,"First we will import the required libraries and draw an empty pitch using RabonaJS."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'import Rabona from "rabonajs";\nimport { useEffect, useRef, useState } from "react";\n\nexport const PassNetwork = () => {\n  const [pitch, setPitch] = useState(null);\n\n  const pitchOptions = {\n    height: 80, //in px\n    width: 120, //in px\n    padding: 100, // in px, distance between the pitch border lines and external border\n    linecolour: "#ffffff",\n    fillcolour: "#7ec850",\n  };\n  useEffect(() => {\n    if (!pitch) {\n      const pitch = Rabona.pitch("pitch", pitchOptions);\n      setPitch(pitch);\n    }\n  }, []);\n  return <div id="pitch" style={{ width: "750px", margin: "auto" }} />;\n};\n')),(0,o.kt)(h,{mdxType:"Pitch"}),(0,o.kt)("h2",{id:"loading-the-data"},"Loading the data"),(0,o.kt)("p",null,"Let's create a dropdown menu to select the match we want to analyze."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'export const MatchSelector = ({ onChange }) => {\n  const [matches, setMatches] = useState([]);\n  /*\n  Here we are fetching the data from github. Any provided competitionId and seasonId will work.\n  */\n  const getData = async () => {\n    const competitionId = 2; // premier league\n    const seasonId = 44; // 2003-2004 season\n    const matchesResponse = await fetch(\n      "https://raw.githubusercontent.com/statsbomb/open-data/master/data/matches/" +\n        competitionId +\n        "/" +\n        seasonId +\n        ".json"\n    );\n    const matches = await matchesResponse.json();\n    setMatches(matches);\n  };\n\n  /*\n    Load the data once the component is mounted\n  */\n  useEffect(() => {\n    getData();\n  }, []);\n\n  const onMatchChange = (e) => {\n    onChange(matches.find((match) => match.match_id === e.target.value));\n  };\n\n  /*\n    Render the dropdown menu\n  */\n  return (\n    <div>\n      <select onChange={onMatchChange}>\n        {matches.map((match) => (\n          <option key={match.match_id} value={match.match_id}>\n            {match.home_team.home_team_name} {match.home_score} -{" "}\n            {match.away_score} {match.away_team.away_team_name}\n          </option>\n        ))}\n      </select>\n    </div>\n  );\n};\n')),(0,o.kt)("h3",{id:"matchselector-component"},"MatchSelector Component"),(0,o.kt)("p",null,"using ",(0,o.kt)("inlineCode",{parentName:"p"},"onChange")," function we can get the selected match id to retrieve the data for that match.\\\nThat will just the log the match id for now."),(0,o.kt)("h3",{id:"try-it-out-\ufe0f"},"Try it out \u26bd\ufe0f"),(0,o.kt)(d,{onChange:e=>console.log(e.target.value),mdxType:"MatchSelector"}),(0,o.kt)("h2",{id:"creating-the-pass-network"},"Creating the pass network"),(0,o.kt)("p",null,"Now we will create a function to create the pass network. A Pass network is weighted graph in mathematical\nterms where the nodes are the players and the edges are the passes between the players.\nThe weight of the edge is the number of passes between the two players.\nIt is calculated by counting total number of passes between players in addition to\naverage position of the players up until the first substitution."),(0,o.kt)("p",null,"Let's start with importing the required methods from Danfo."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Don't forget to install danfojs using ",(0,o.kt)("inlineCode",{parentName:"p"},"npm install danfojs")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn add danfojs"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'import { DataFrame, merge, toJSON } from "danfojs/dist/danfojs-browser/src";\n')),(0,o.kt)("p",null,"Here we are only importing necessary methods to reduce bundle size on browser"),(0,o.kt)("h3",{id:"fetch-the-match-data"},"Fetch the match data"),(0,o.kt)("p",null,"First we are fetching the match data from github using the match id."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const matchResponse = await fetch(\n  "https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/" +\n    matchId +\n    ".json"\n);\nconst match = await matchResponse.json();\n')),(0,o.kt)("p",null,"Then we are looping through the events and filtering out the passes and storing them in an array.\nWe should make sure that event is a pass and it has a recipient. This way unsuccesful passes are not included.\nDon't forget the break the loop after the first substitution."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const passes = [];\nfor (let i = 0; i < match.length; i++) {\n  const event = match[i];\n  if (event.type.name === "Substitution") {\n    break;\n  }\n  if (match[i].type.name === "Pass" && event.pass.recipient) {\n    passes.push({\n      startX: event.location[0],\n      startY: event.location[1],\n      endX: event.pass.end_location[0],\n      endY: event.pass.end_location[1],\n      teamId: event.team.id,\n      passer: event.player?.id,\n      passerName: event.player?.name,\n      recipient: event.pass.recipient?.id,\n    });\n  }\n}\n')),(0,o.kt)("h3",{id:"creating-the-pass-network-1"},"Creating the pass network"),(0,o.kt)("p",null,"Below we are creating a DataFrame from the passes array and grouping the passes by the passer and team id.\nAfterwards calculating the average position of the passer and the number of passes made by the passer."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const df = new DataFrame(passes);\nconst avereagePositions = df\n  .groupby(["passer", "teamId"])\n  .agg({ startX: "mean", startY: ["mean", "count"] })\n  .rename({ startY_count: "total_pass_count" });\n')),(0,o.kt)("p",null,"Whole function looks like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'export const getPassNetworkData = async (matchId) => {\n  const matchResponse = await fetch(\n    "https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/" +\n      matchId +\n      ".json"\n  );\n  const match = await matchResponse.json();\n  const passes = [];\n  for (let i = 0; i < match.length; i++) {\n    const event = match[i];\n    if (event.type.name === "Substitution") {\n      break;\n    }\n    if (match[i].type.name === "Pass" && event.pass.recipient) {\n      passes.push({\n        startX: event.location[0],\n        startY: event.location[1],\n        endX: event.pass.end_location[0],\n        endY: event.pass.end_location[1],\n        teamId: event.team.id,\n        passer: event.player?.id,\n        passerName: event.player?.name,\n        recipient: event.pass.recipient?.id,\n      });\n    }\n  }\n  // highlight-start\n  const df = new DataFrame(passes);\n  const avereagePositions = df\n    .groupby(["passer", "teamId"])\n    .agg({ startX: "mean", startY: ["mean", "count"] })\n    .rename({ startY_count: "total_pass_count" });\n  // highlight-end\n};\n')),(0,o.kt)("p",null,"This function returns a DataFrame with the average position of the passer and\nthe number of passes made by the passer. We will use this DataFrame to create the nodes of the graph."),(0,o.kt)("p",null,"This data would look like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "passer": 12529,\n    "teamId": 1,\n    "startX_mean": 49.91,\n    "startY_mean": 8.515,\n    "total_pass_count": 20\n}\n')),(0,o.kt)("p",null,"At the next stage we will figure out the passes between each player.\nWe will do this by grouping the passes by the passer and the recipient. Passer's name\nis also added to the DataFrame. We will use these information to visualize the nodes of the graph."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const passBetween = df\n  .groupby(["passer", "recipient", "passerName", "passerNumber"])\n  .agg({ startY: ["count"] })\n  .rename({ startY_count: "count" })\n  .rename({ passerName: "label" });\n')),(0,o.kt)("p",null,"This data would look like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "passer": 12529,\n    "recipient": 40221,\n    "label": "J. Henderson",\n    "passerNumber": 14,\n    "count": 9\n},\n{\n    "passer": 12529,\n    "recipient": 1347,\n    "label": "J. Henderson",\n    "passerNumber": 14,\n    "count": 17\n},\n')),(0,o.kt)("p",null,"All we need to do is merging these two datasets by using the ",(0,o.kt)("inlineCode",{parentName:"p"},"merge")," method we imported early on."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const passData = merge({\n  left: passBetween,\n  right: avereagePositions,\n  on: ["passer"],\n  how: "left",\n});\n')),(0,o.kt)("p",null,"This will give us a DataFrame with most of the information we need to create the nodes and edges of the graph."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "passer": 12529,\n    "recipient": 40221,\n    "label": "J. Henderson",\n    "passerNumber": 14,\n    "count": 9,\n    "teamId": 1,\n    "startX_mean": 49.91,\n    "startY_mean": 8.515,\n    "total_pass_count": 20\n},\n{\n    "passer": 12529,\n    "recipient": 1347,\n    "label": "J. Henderson\n    ...\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"total_pass_count")," is the total number of passes made by the passer and ",(0,o.kt)("inlineCode",{parentName:"p"},"count"),"\nis the number of passes made between the passer and the recipient.\nWe still need to create recipient's average position and we will use it to create the edges of the graph.\nA simple ",(0,o.kt)("inlineCode",{parentName:"p"},"map")," function will do the trick after converting the DataFrame to JSON.\nMapping function will find the recipient's average position from the ",(0,o.kt)("inlineCode",{parentName:"p"},"avereagePositions"),"\nand add it to the ",(0,o.kt)("inlineCode",{parentName:"p"},"passNetwork"),". That will correspond the end locations of the passes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'let passDataJson = toJSON(passData);\nlet averagePositionsJson = toJSON(avereagePositions);\nconst passNetwork = passDataJson.map((pass) => ({\n  ...pass,\n  endX: averagePositionsJson.find(\n    (position) => pass.recipient === position.passer\n  ).startX,\n  endY: averagePositionsJson.find(\n    (position) => pass.recipient === position.passer\n  ).startY,\n  startX: pass.startX,\n  startY: pass.startY,\n  label: pass.label.split(" ")[1], // simplify the name by getting the last or middle name\n}));\n')),(0,o.kt)("h3",{id:"home-and-away-selector-component"},"Home and away selector component"),(0,o.kt)("p",null,"A simple home and away selector could be useful at this stage to visualize the passes for a specific team.\nAn ordinary radio button will work just fine. We will use the ",(0,o.kt)("inlineCode",{parentName:"p"},"activeTeamId")," state to keep track of the selected team.\nWe will also use the ",(0,o.kt)("inlineCode",{parentName:"p"},"onActiveTeamChange")," function to update the state."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'const HomeAwaySelector = ({ homeAway, onActiveTeamChange, activeTeamId }) => {\n  return (\n    <div>\n      <label>\n        <input\n          type="radio"\n          name="home-away"\n          value={homeAway.home}\n          checked={homeAway.home == activeTeamId}\n          onChange={(e) => onActiveTeamChange(e.target.value)}\n        />\n        Home\n      </label>\n      <label>\n        <input\n          type="radio"\n          name="home-away"\n          value={homeAway.away}\n          checked={homeAway.away == activeTeamId}\n          onChange={(e) => onActiveTeamChange(e.target.value)}\n        />\n        Away\n      </label>\n    </div>\n  );\n};\n')),(0,o.kt)("h3",{id:"final-result"},"Final Result"),(0,o.kt)("p",null,"At this stage we will combine all the components we created earlier to create the final result."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MatchSelector")," component let us select the game we want to visualize the passes for."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"HomeAwaySelector")," component is a team toggle to visualize the passes for."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"PassNetwork")," is the component that visualizes the passes.")),(0,o.kt)("p",null,"In a pass network dependent on the density of passes between players specific lines will be thicker.\n",(0,o.kt)("inlineCode",{parentName:"p"},"count")," filed can be used to calculate the thickness of the lines. In other to make the lines more visible\nnormalizing the data between 0 and 2 pixels is a good idea to make it fit with ",(0,o.kt)("inlineCode",{parentName:"p"},"Rabonajs")," well.\nHave a look at this ",(0,o.kt)("inlineCode",{parentName:"p"},"norm")," function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export const norm = (val, max = 2, min = 0) => {\n  return (val - min) / (max - min);\n};\n")),(0,o.kt)("p",null,"So when we set the ",(0,o.kt)("inlineCode",{parentName:"p"},"Rabona")," layer we can set the width of the lines simply like this."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'Rabona.layer({\n  type: "ballMovement",\n  data: passNetworkData,\n  options: {\n    color: "yellow",\n    // highlight-start\n    getWidth: (pass) => norm(pass?.count),\n    // highlight-end\n  },\n}).addTo(pitch);\n')),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"getWidth")," is let you loop thourogh the data you passes and set the width of the lines dynamically."),(0,o.kt)("p",{parentName:"admonition"},"You can look at the dynamic coloring example here to see how to use ",(0,o.kt)("inlineCode",{parentName:"p"},"Rabonajs")," to create a dynamic coloring for the ball movement.\n\ud83d\udc49 ",(0,o.kt)("a",{parentName:"p",href:"https://orabazu.github.io/rabonajs-docs/docs/tutorial-basics/plot-shots"},"Plot Shots"))),(0,o.kt)("p",null,"When combined together as a helper function it will look like this."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'const drawPassNetwork = (passNetwork, activeTeamId) => {\n  // Filter the data by the active team\n  const filteredData = passNetwork.filter(\n    (pass) => pass.teamId == activeTeamId\n  );\n  // Clear the pitch\n  pitch.removeAllLayers();\n  Rabona.layer({\n    type: "ballMovement",\n    data: filteredData,\n    options: {\n      color: "yellow",\n      getWidth: (pass) => norm(pass?.count),\n    },\n  }).addTo(pitch);\n};\n')),(0,o.kt)("p",null,"We will also need to call the ",(0,o.kt)("inlineCode",{parentName:"p"},"onMatchChange")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"onActiveTeamChange")," functions\nto update the ",(0,o.kt)("inlineCode",{parentName:"p"},"passNetwork")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"activeTeamId")," states. These will be triggerd when ",(0,o.kt)("inlineCode",{parentName:"p"},"MatchSelector")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"HomeAwaySelector")," components change."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const onMatchChange = async (match) => {\n  // highlight-start\n  setHomeAway({\n    home: match.home_team.home_team_id,\n    away: match.away_team.away_team_id,\n  });\n  setActiveTeamId(match.home_team.home_team_id);\n  const passNetwork = await getPassNetworkData(match.match_id);\n  setPassNetwork(passNetwork);\n  drawPassNetwork(passNetwork, match.home_team.home_team_id);\n};\nconst onActiveTeamChange = (teamId) => {\n  setActiveTeamId(teamId);\n  drawPassNetwork(passNetwork, teamId);\n};\n// highlight-end\n")),(0,o.kt)("h2",{id:"putting-it-all-together"},"Putting it all together"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="HomeAwaySelector.jsx"',title:'"HomeAwaySelector.jsx"'},'export const HomeAwaySelector = ({\n  homeAway,\n  onActiveTeamChange,\n  activeTeamId,\n}) => {\n  return (\n    homeAway && (\n      <div>\n        <label>\n          <input\n            type="radio"\n            name="home-away"\n            value={homeAway.home}\n            checked={homeAway.home == activeTeamId}\n            onChange={(e) => onActiveTeamChange(e.target.value)}\n          />\n          Home\n        </label>\n        <label>\n          <input\n            type="radio"\n            name="home-away"\n            value={homeAway.away}\n            checked={homeAway.away == activeTeamId}\n            onChange={(e) => onActiveTeamChange(e.target.value)}\n          />\n          Away\n        </label>\n      </div>\n    )\n  );\n};\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="getPassNetworkData"',title:'"getPassNetworkData"'},'export const getPassNetworkData = async (matchId) => {\n  const matchResponse = await fetch(\n    "https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/" +\n      matchId +\n      ".json"\n  );\n  const match = await matchResponse.json();\n  const passes = [];\n  for (let i = 0; i < match.length; i++) {\n    const event = match[i];\n    if (event.type.name === "Substitution") {\n      break;\n    }\n    if (match[i].type.name === "Pass" && event.pass.recipient) {\n      passes.push({\n        startX: event.location[0],\n        startY: event.location[1],\n        endX: event.pass.end_location[0],\n        endY: event.pass.end_location[1],\n        teamId: event.team.id,\n        passer: event.player?.id,\n        passerName: event.player?.name,\n        recipient: event.pass.recipient?.id,\n      });\n    }\n  }\n  // highlight-start\n  const df = new DataFrame(passes);\n  const avereagePositions = df\n    .groupby(["passer", "teamId"])\n    .agg({ startX: "mean", startY: ["mean", "count"] })\n    .rename({ startX_mean: "startX", startY_mean: "startY" })\n    .rename({ startY_count: "total_pass_count" });\n  const passBetween = df\n    .groupby(["passer", "recipient", "passerName"])\n    .agg({ startY: ["count"] })\n    .rename({ startY_count: "count" })\n    .rename({ passerName: "label" });\n  const passData = merge({\n    left: passBetween,\n    right: avereagePositions,\n    on: ["passer"],\n    how: "left",\n  });\n  let passDataJson = toJSON(passData);\n  let averagePositionsJson = toJSON(avereagePositions);\n  const passNetwork = passDataJson.map((pass) => ({\n    ...pass,\n    endX: averagePositionsJson.find(\n      (position) => pass.recipient === position.passer\n    ).startX,\n    endY: averagePositionsJson.find(\n      (position) => pass.recipient === position.passer\n    ).startY,\n    startX: pass.startX,\n    startY: pass.startY,\n    label: pass.label.split(" ")[1],\n  }));\n  return passNetwork;\n  // highlight-end\n};\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="PassNetwork.jsx"',title:'"PassNetwork.jsx"'},'export const PassNetwork = () => {\n  const [pitch, setPitch] = useState(null);\n  const [homeAway, setHomeAway] = useState(null);\n  const [activeTeamId, setActiveTeamId] = useState(null);\n  const [passNetwork, setPassNetwork] = useState(null);\n  const pitchOptions = {\n    height: 80, //in px\n    width: 120, //in px\n    padding: 100, // in px, distance between the pitch border lines and external border\n    linecolour: "#ffffff",\n    fillcolour: "#7ec850",\n  };\n\n  useEffect(() => {\n    if (!pitch) {\n      const pitch = Rabona.pitch("pitch", pitchOptions);\n      setPitch(pitch);\n    }\n  }, []);\n\n  // highlight-start\n  const drawPassNetwork = (passNetwork, activeTeamId) => {\n    const filteredData = passNetwork.filter(\n      (pass) => pass.teamId == activeTeamId\n    );\n    pitch.removeAllLayers();\n    Rabona.layer({\n      type: "ballMovement",\n      data: filteredData,\n      options: {\n        color: "yellow",\n        getWidth: (pass) => norm(pass?.count),\n      },\n    }).addTo(pitch);\n  };\n  // highlight-end\n\n  const onMatchChange = async (match) => {\n    setHomeAway({\n      home: match.home_team.home_team_id,\n      away: match.away_team.away_team_id,\n    });\n    setActiveTeamId(match.home_team.home_team_id);\n    const passNetwork = await getPassNetworkData(match.match_id);\n    setPassNetwork(passNetwork);\n    // highlight-start\n    drawPassNetwork(passNetwork, match.home_team.home_team_id);\n    // highlight-end\n  };\n\n  const handleActiveTeamChange = (teamId) => {\n    setActiveTeamId(teamId);\n    // highlight-start\n    drawPassNetwork(passNetwork, teamId);\n    // highlight-start\n  };\n\n  return (\n    <>\n      <MatchSelector onChange={onMatchChange} />\n      <HomeAwaySelector\n        homeAway={homeAway}\n        onActiveTeamChange={handleActiveTeamChange}\n        activeTeamId={activeTeamId}\n      />\n      <div id="pitch" style={{ width: "750px", margin: "auto" }} />\n    </>\n  );\n};\n')),(0,o.kt)("h3",{id:"try-it-out-\ufe0f-1"},"Try it out \u26bd\ufe0f"),(0,o.kt)(f,{mdxType:"PassNetwork"}),(0,o.kt)("h3",{id:"flipping-away-team-coordinates"},"Flipping away team coordinates"),(0,o.kt)("p",null,"Wait, there something weird going on here. The away team is on the left side of the pitch.\nWe need to flip the coordinates of the away team to make it look like the home team is on the left side of the pitch.\nLuckily, we can do this with a simple transformation, since we have access to pitch options of ",(0,o.kt)("inlineCode",{parentName:"p"},"Rabona.pitch"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export const mirrorX = (val, pitch) => {\n  return pitch?.getOptions().width - val;\n};\n\nexport const mirrorY = (val, pitch) => {\n  return pitch?.getOptions().height - val;;\n};\n\n")),(0,o.kt)("p",null,"So how does that works? If value of the pitch is 120, and we have a value of 40, we need to subtract 40 from 120 to get 80 which is the mirrored value.\nWe can use this function to mirror the coordinates of the away team when we prepare the pass network data"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'\nexport const getPassNetworkData = async (matchId) => {\n  const matchResponse = await fetch(\n    "https://raw.githubusercontent.com/statsbomb/open-data/master/data/events/" +\n      matchId +\n      ".json"\n  );\n  const match = await matchResponse.json();\n  // highlight-start\n  const isHome = (teamId) => match.home_team.home_team_id === teamId;\n  // highlight-end\n  const passes = [];\n  for (let i = 0; i < match.length; i++) {\n    const event = match[i];\n    if (event.type.name === "Substitution") {\n      break;\n    }\n    if (match[i].type.name === "Pass" && event.pass.recipient) {\n      passes.push({\n        // highlight-start\n        startX: isHome(pass.team.id) ? event.location[0] : mirrorX(event.location[0], pitch),\n        startY: isHome(pass.team.id) ? event.location[1] : mirrorY(event.location[1], pitch),\n        endX: isHome(pass.team.id) ? event.pass.end_location[0] : mirrorX(event.pass.end_location[0], pitch),\n        endY: isHome(pass.team.id) ? event.pass.end_location[1] : mirrorY(event.pass.end_location[1], pitch),\n        // highlight-end\n        teamId: event.team.id,\n        passer: event.player?.id,\n        passerName: event.player?.name,\n        recipient: event.pass.recipient?.id,\n      });\n    }\n  }\n...\n}\n  \n')),(0,o.kt)("h3",{id:"try-it-out-\ufe0f-2"},"Try it out \u26bd\ufe0f"),(0,o.kt)(b,{mdxType:"PassNetwork2"}))}_.isMDXComponent=!0},75410:()=>{},48628:()=>{},31601:()=>{},67792:()=>{},34977:()=>{},75042:()=>{},55382:()=>{},72095:()=>{},61219:()=>{}}]);